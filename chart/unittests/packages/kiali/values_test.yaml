# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Package - Kiali - Values Tests
templates:
  - templates/kiali/values.yaml
tests:
  - it: make assertions on the default values for Kiali
    postRenderer:
      cmd: "sh"
      args:
        - "-c"
        - "yq eval '.stringData.defaults' - | yq eval '.'"
    set:
      istiod.values.hardened.enabled: true
    asserts:
      - equal:
          path: domain
          value: "dev.bigbang.mil"
      - equal:
          path: istio.enabled
          value: true
  - it: should enable istio sidecar when kiali hardened is enabled
    postRenderer:
      cmd: "sh"
      args:
        - "-c"
        - "yq eval '.stringData.defaults' - | yq eval '.'"
    set:
      kiali.values.hardened.enabled: true
    asserts:
      - equal:
          path: istio.sidecar.enabled
          value: true
  - it: should map customServiceEntries to istio.serviceEntries.custom
    postRenderer:
      cmd: "sh"
      args:
        - "-c"
        - "yq eval '.stringData.overlays' - | yq eval '.'"
    set:
      kiali.values.istio.hardened.customServiceEntries:
        - name: "test-service-entry"
          hosts:
            - "example.com"
    asserts:
      - equal:
          path: istio.serviceEntries.custom[0].name
          value: "test-service-entry"
      - equal:
          path: istio.serviceEntries.custom[0].hosts[0]
          value: "example.com"
  - it: should map customAuthorizationPolicies to istio.authorizationPolicies.custom
    postRenderer:
      cmd: "sh"
      args:
        - "-c"
        - "yq eval '.stringData.overlays' - | yq eval '.'"
    set:
      kiali.values.istio.hardened.customAuthorizationPolicies:
        - name: "test-authz-policy"
          labels:
            app: "kiali"
    asserts:
      - equal:
          path: istio.authorizationPolicies.custom[0].name
          value: "test-authz-policy"
      - equal:
          path: istio.authorizationPolicies.custom[0].labels.app
          value: "kiali"
  - it: should merge both istio.serviceEntries.custom and istio.hardened.customServiceEntries
    postRenderer:
      cmd: "sh"
      args:
        - "-c"
        - "yq eval '.stringData.overlays' - | yq eval '.'"
    set:
      kiali.values.istio.hardened.customServiceEntries:
        - name: "hardened-entry"
          spec:
            hosts:
              - "hardened.example.com"
      kiali.values.istio.serviceEntries.custom:
        - name: "custom-entry"
          spec:
            hosts:
              - "custom.example.com"
    asserts:
      - equal:
          path: istio.serviceEntries.custom[0].name
          value: "hardened-entry"
      - equal:
          path: istio.serviceEntries.custom[0].spec.hosts[0]
          value: "hardened.example.com"
      - equal:
          path: istio.serviceEntries.custom[1].name
          value: "custom-entry"
      - equal:
          path: istio.serviceEntries.custom[1].spec.hosts[0]
          value: "custom.example.com"

