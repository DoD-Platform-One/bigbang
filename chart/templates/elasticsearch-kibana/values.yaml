{{- if .Values.elasticsearchKibana.enabled }}
{{- /* Create a cleaned copy of elasticsearchKibana config and merge deprecated paths into current paths */ -}}
{{- $elasticsearchKibanaPackage := deepCopy .Values.elasticsearchKibana -}}
{{- if .Values.elasticsearchKibana.values -}}
{{- $cleanedValues := include "mergeLegacyIstioHardenedKeys" (dict "values" .Values.elasticsearchKibana.values) | fromYaml -}}
{{- $elasticsearchKibanaPackage = set $elasticsearchKibanaPackage "values" $cleanedValues -}}
{{- end -}}
{{- include "values-secret" (dict "root" $ "package" $elasticsearchKibanaPackage "name" "ek" "defaults" (merge (include "bigbang.elasticsearchKibana.bb-common-migrations" . | fromYaml) (include "bigbang.defaults.logging" . | fromYaml) | toYaml)) }}
{{- end }}

{{- define "bigbang.defaults.logging" -}}
# hostname is deprecated and replaced with domain. But if hostname exists then use it.
{{- $domainName := default .Values.domain .Values.hostname }}
{{- $istioEnabled := eq (include "istioEnabled" .) "true" }}
{{- $istioInjection := and $istioEnabled (eq (dig "istio" "injection" "enabled" .Values.elasticsearchKibana) "enabled") }}
{{- $istioHardenedEnabled := or (dig "istio" "hardened" "enabled" false .Values.elasticsearchKibana.values) (dig "hardened" "enabled" false .Values.istiod.values) (dig "hardened" "enabled" false .Values.elasticsearchKibana.values) }}
{{- $disableDefaultFLB := dig "additionalOutputs" "disableDefault" false .Values.fluentbit.values }}
hostname: {{ $domainName }}
domain: {{ $domainName }}

openshift: {{ .Values.openshift }}

imagePullPolicy: {{ .Values.imagePullPolicy }}

istio:
  enabled: {{ $istioEnabled }}

  sidecar:
    enabled: {{ $istioHardenedEnabled }}

  authorizationPolicies:
    enabled: {{ $istioHardenedEnabled }}
    generateFromNetpol: {{ $istioHardenedEnabled }}

networkPolicies:
  enabled: {{ .Values.networkPolicies.enabled }}

  # note: ztunnel does not exist yet, defaulting to false until ambient package is added
  hbonePortInjection:
    enabled: {{ dig "enabled" false (default dict .Values.ztunnel) }}

  egress:
    definitions:
      sso:
        {{ toYaml .Values.networkPolicies.egress.definitions.sso | nindent 8 }}
    from:
      elasticsearch:
        podSelector:
          matchLabels:
            common.k8s.elastic.co/type: elasticsearch
        to:
          definition:
            sso: {{ .Values.elasticsearchKibana.sso.enabled }}
  ingress:
    to:
      # Elasticsearch ingress policies
      elasticsearch:9200:
        podSelector:
          matchLabels:
            common.k8s.elastic.co/type: elasticsearch
        from:
          k8s:
            # Allow Fluentbit to write logs to Elasticsearch
            fluentbit-fluent-bit@fluentbit/fluent-bit: {{ and .Values.fluentbit.enabled (not $disableDefaultFLB)  }}

            # Allow Mattermost to write to Elasticsearch 
            mattermost@mattermost/mattermost: {{ and .Values.addons.mattermost.elasticsearch.enabled .Values.addons.mattermost.enabled  }}


      # Metrics exporter ingress
      metrics:9108:
        from:
          k8s:
            # Allow Prometheus to scrape metrics
            monitoring/prometheus: {{ .Values.monitoring.enabled  }}

{{- with .Values.elasticsearchKibana.sso }}
{{- if .enabled }}
sso:
  enabled: {{ .enabled }}
  client_id: {{ .client_id | quote }}
  client_secret: {{ .client_secret | default "no-secret" }}
  oidc:
    host: {{ default (include "sso.host" $) (dig "oidc" "host" "" .) | quote }}
    realm: {{ default (include "sso.realm" $) (dig "oidc" "realm" "" .) | quote }}
  {{- /* Optional fields should be nil checked */ -}}
  {{- $legacy := and (not (empty $.Values.sso.oidc.realm)) (not (empty $.Values.sso.oidc.host)) -}}
  {{- list "issuer" (default (ternary nil (include "sso.url" $) $legacy) .issuer) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "auth_url" (default (ternary nil (include "sso.oidc.auth" $) $legacy) .auth_url) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "token_url" (default (ternary nil (include "sso.oidc.token" $) $legacy) .token_url) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "userinfo_url" (default (ternary nil (include "sso.oidc.userinfo" $) $legacy) .userinfo_url) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "jwkset_url" (default (ternary nil (include "sso.oidc.jwksuri" $) $legacy) .jwkset_url) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "claims_principal" (default (ternary nil (dig "oidc" "claims" "username" nil $.Values.sso) $legacy) .claims_principal) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "claims_principal_pattern" .claims_principal_pattern | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "requested_scopes" .requested_scopes | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "signature_algorithm" .signature_algorithm | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "endsession_url" (default (ternary nil (include "sso.oidc.endsession" $) $legacy) .endsession_url) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "claims_group" (default (ternary nil (dig "oidc" "claims" "groups" nil $.Values.sso) $legacy) .claims_group) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "claims_mail" (default (ternary nil (dig "oidc" "claims" "email" nil $.Values.sso) $legacy) .claims_mail) | include "bigbang.addValueIfSet" | indent 2 }}
  {{- list "cert_authorities" .cert_authorities | include "bigbang.addValueIfSet" | indent 2 }}
{{- end }}
{{- end }}

kibana:
  imagePullSecrets:
    - name: private-registry
{{- if $istioEnabled }}
  podAnnotations:
    {{ include "istioAnnotation" . }}
{{- end }}

{{- if not .Values.elasticsearchKibana.serviceAccountAnnotations.kibana }}
  serviceAccountAnnotations: {}
{{- else }}
  serviceAccountAnnotations: {{ toYaml .Values.elasticsearchKibana.serviceAccountAnnotations.kibana | nindent 4 }}
{{- end }}
monitoring:
  enabled: {{ .Values.monitoring.enabled }}

metrics:
  enabled: {{ .Values.monitoring.enabled }}
  {{- if and (eq (dig "istio" "mtls" "mode" "STRICT" .Values.elasticsearchKibana.values) "STRICT") $istioInjection }}
  serviceMonitor:
    scheme: https
    tlsConfig:
      caFile: /etc/prom-certs/root-cert.pem
      certFile: /etc/prom-certs/cert-chain.pem
      keyFile: /etc/prom-certs/key.pem
      insecureSkipVerify: true
  {{- end }}

elasticsearch:
  imagePullSecrets:
    - name: private-registry
  master:
    initContainers:
      - name: elastic-internal-init-filesystem
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      - name: elastic-internal-suspend
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- if .Values.elasticsearchKibana.sso.enabled }}
      - name: elastic-internal-init-keystore
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- end }}
    {{- if $istioEnabled }}
    podAnnotations:
      {{ include "istioAnnotation" . }}
    {{- end }}
  data:
    initContainers:
      - name: elastic-internal-init-filesystem
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      - name: elastic-internal-suspend
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- if .Values.elasticsearchKibana.sso.enabled }}
      - name: elastic-internal-init-keystore
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- end }}
    {{- if $istioEnabled }}
    podAnnotations:
      {{ include "istioAnnotation" . }}
    {{- end }}
  ingest:
    initContainers:
      - name: elastic-internal-init-filesystem
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      - name: elastic-internal-suspend
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- if .Values.elasticsearchKibana.sso.enabled }}
      - name: elastic-internal-init-keystore
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- end }}
    {{- if $istioEnabled }}
    podAnnotations:
      {{ include "istioAnnotation" . }}
    {{- end }}
  ml:
    initContainers:
      - name: elastic-internal-init-filesystem
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      - name: elastic-internal-suspend
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- if .Values.elasticsearchKibana.sso.enabled }}
      - name: elastic-internal-init-keystore
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- end }}
    {{- if $istioEnabled }}
    podAnnotations:
      {{ include "istioAnnotation" . }}
    {{- end }}
  coord:
    initContainers:
      - name: elastic-internal-init-filesystem
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      - name: elastic-internal-suspend
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- if .Values.elasticsearchKibana.sso.enabled }}
      - name: elastic-internal-init-keystore
        securityContext:
          privileged: false
          capabilities:
            drop:
              - ALL
      {{- end }}
    {{- if $istioEnabled }}
    podAnnotations:
      {{ include "istioAnnotation" . }}
    {{- end }}
  {{- if not .Values.elasticsearchKibana.serviceAccountAnnotations.elasticsearch }}
  serviceAccountAnnotations: {}
  {{- else }}
  serviceAccountAnnotations: {{ toYaml .Values.elasticsearchKibana.serviceAccountAnnotations.elasticsearch | nindent 4 }}
  {{- end }}
{{- end -}}
