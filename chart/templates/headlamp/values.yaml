{{- if .Values.addons.headlamp.enabled }}
{{- $headlampPackage := deepCopy .Values.addons.headlamp -}}
{{- if .Values.addons.headlamp.values }}
{{- $cleanedValues := include "mergeLegacyIstioHardenedKeys" (dict "values" .Values.addons.headlamp.values) | fromYaml -}}
{{- $_ := set $headlampPackage "values" $cleanedValues }}
{{- end -}}
{{- include "values-secret" (dict
  "root" $
  "package" $headlampPackage
  "name" "headlamp"
  "defaults" (merge (include "bigbang.headlamp.bb-common-migrations" . | fromYaml) (include "bigbang.defaults.headlamp" . | fromYaml) | toYaml)
)}}
{{- end }}

{{- define "bigbang.defaults.headlamp" -}}
{{- $istioHardenedEnabled := dig "hardened" "enabled" false .Values.istiod.values }}
istio:
  enabled: {{ .Values.istiod.enabled }}
  authorizationPolicies:
    enabled: {{ $istioHardenedEnabled }}
    generateFromNetpol: {{ $istioHardenedEnabled }}
  sidecar:
    enabled: {{ $istioHardenedEnabled }}

networkPolicies:
  enabled: {{ .Values.networkPolicies.enabled }}
  egress:
    definitions: {{ .Values.networkPolicies.egress.definitions | toYaml | nindent 6 }}
    from:
      headlamp:
        to:
          k8s:
            tempo/tempo:9411: {{ .Values.tempo.enabled }}
          definition:
            kubeAPI: true
            sso: {{ .Values.addons.headlamp.sso.enabled }}
  ingress:
    definitions: {{ .Values.networkPolicies.ingress.definitions | toYaml | nindent 6 }}
    to:
      headlamp:4466:
        from:
          k8s:
            monitoring-monitoring-prometheus-blackbox-exporter@monitoring/prometheus-blackbox-exporter: {{ .Values.monitoring.enabled }}

{{- $baseURL := dig "upstream" "config" "baseURL" "" .Values.addons.headlamp.values }}
{{- $port := dig "upstream" "service" "port" 4466 .Values.addons.headlamp.values }}
{{- $serviceName := "headlamp-headlamp" }}
{{- $ssoHost := "" }}
{{- if .Values.addons.headlamp.sso.enabled }}
{{- $ssoHost = include "sso.url" . | trimPrefix "https://" | regexFind "^[^/]+" }}
{{- end }}
routes:
  inbound:
    headlamp:
      {{- if empty $baseURL }}
      service: {{ $serviceName }}
      port: {{ $port }}
      {{- else }}
      http:
      - match:
        - uri:
            exact: {{ $baseURL }}
        rewrite:
          uri: {{ $baseURL }}/
        route:
        - destination:
            host: {{ $serviceName }}
            port:
              number: {{ $port }}
      - match:
        - uri:
            prefix: {{ $baseURL }}
        route:
        - destination:
            host: {{ $serviceName }}
            port:
              number: {{ $port }}
      {{- end }}
  outbound:
    sso:
      enabled: {{ .Values.addons.headlamp.sso.enabled }}
      {{- if $ssoHost }}
      hosts:
        - {{ $ssoHost }}
      {{- end }}

{{- $domainName := default .Values.domain .Values.hostname }}
domain: {{ $domainName }}

image:
  imagePullPolicy: {{ .Values.imagePullPolicy }}

{{- if (eq (include "istioEnabled" .) "true") }}
annotations:
  {{ include "istioAnnotation" . }}
{{- end }}

openshift: {{ .Values.openshift }}

{{- if .Values.addons.headlamp.sso.enabled }}
upstream:
  config:
    oidc:
      clientID: {{ .Values.addons.headlamp.sso.client_id }}
      issuerURL: {{ .Values.sso.url }}
      scopes: "email,profile"
      usePKCE: true
{{- else }}
upstream:
  config:
    oidc:
      secret:
       create: false
{{- end }}
{{- end -}}
