{{- /* Create secret */ -}}
{{- if .Values.alloy.enabled }}
{{- /* Create a cleaned copy of alloy config and merge deprecated paths into current paths */ -}}
{{- $alloyPackage := deepCopy .Values.alloy -}}
{{- if .Values.alloy.values -}}
{{- $cleanedValues := include "mergeLegacyIstioHardenedKeys" (dict "values" .Values.alloy.values) | fromYaml -}}
{{- $alloyPackage = set $alloyPackage "values" $cleanedValues -}}
{{- end -}}
{{- include "values-secret" (dict "root" $ "package" $alloyPackage "name" "alloy" "defaults" (include "bigbang.defaults.alloy" .)) }}
{{- end }}

{{- define "bigbang.defaults.alloy" -}}
{{- $alloyLogsEnabled := (dig "alloyLogs" "enabled" false .Values.alloy) }}
{{- $istioEnabled := eq (include "istioEnabled" .) "true" }}
{{- $istioHardenedEnabled := or (dig "istio" "hardened" "enabled" false .Values.alloy.values) (dig "hardened" "enabled" false .Values.istiod.values) }}

{{- $lokiServiceMap := dict
    "monolith" "logging-loki"
    "scalable" "logging-loki-write"
    "distributed" "logging-loki-distributor"
}}
{{- $lokiServiceName := index $lokiServiceMap .Values.loki.strategy }}
{{- $lokiWriteDestUrl := printf "http://%s.logging.svc.cluster.local:3100/loki/api/v1/push" $lokiServiceName }}

{{- $istioInjection := (and $istioEnabled (eq (dig "istio" "injection" "enabled" .Values.alloy) "enabled")) }}

monitoring:
  enabled: {{ .Values.monitoring.enabled }}

networkPolicies:
  enabled: {{ .Values.networkPolicies.enabled }}
  # note: ztunnel does not exist yet, defaulting to false until ambient package is added
  hbonePortInjection:
    enabled: {{ dig "enabled" false (default dict .Values.ztunnel) }}
  ingress:
    to:
      alloy-logs:12345:
        from:
          k8s:
            monitoring-monitoring-kube-prometheus@monitoring/prometheus: {{ .Values.monitoring.enabled }}
  egress:
    definitions:
      kubeAPI:
        to:
          - ipBlock:
              cidr: {{ .Values.networkPolicies.controlPlaneCidr }}
          {{- if ne .Values.networkPolicies.vpcCidr "0.0.0.0/0" }}
          - ipBlock:
              cidr: {{ .Values.networkPolicies.vpcCidr }}
          {{- end }}
    from:
      alloy-logs:
        to:
          k8s:
            # Loki egress: namespace with app.kubernetes.io/name=logging, pod with app.kubernetes.io/name=logging-loki, port 3100
            logging/logging-loki:3100: {{ .Values.loki.enabled }}
      alloy:
        to:
          tempo/tempo:4317: {{ .Values.tempo.enabled }}
istio:
  enabled: {{ $istioEnabled }}

  sidecar:
    enabled: {{ $istioHardenedEnabled }}

  authorizationPolicies:
    enabled: {{ $istioHardenedEnabled }}
    generateFromNetpol: {{ $istioHardenedEnabled }}

upstream:
  {{- if .Values.kiali.enabled }}
  alloy:
    extraLabels:
      service.istio.io/canonical-name: alloy-alloy-logs
  {{- end }}
  destinations:
    {{- if and $alloyLogsEnabled .Values.loki.enabled }}
    - name: loki
      type: loki
      url: {{ $lokiWriteDestUrl }}
    {{- end }}
  {{- if .Values.alloy.additionalDestinations }}
  {{- toYaml .Values.alloy.additionalDestinations | nindent 4 }}
  {{- end }}
  {{- if $alloyLogsEnabled }}
  alloy-logs:
    enabled: true
  podLogs:
    enabled: true
    destinations:
      {{- if .Values.loki.enabled }}
      - loki
      {{- end }}
      {{- if .Values.alloy.additionalDestinations }}
      {{- range $dest := .Values.alloy.additionalDestinations }}
      {{- if eq (lower $dest.type) "loki" }}
      - {{ $dest.name }}
      {{- end }}
      {{- end }}
      {{- end }}
    collector: alloy-logs
    labelsToKeep:
      - app.kubernetes.io/name
      - container
      - instance
      - job
      - level
      - namespace
      - service.name
      - service.namespace
      - deployment.environment
      - deployment.environment.name
      - k8s.namespace.name
      - k8s.deployment.name
      - k8s.statefulset.name
      - k8s.daemonset.name
      - k8s.cronjob.name
      - k8s.job.name
      - k8s.node.name
      - k8s.pod.name
      - pod
    structuredMetadata:
      k8s.pod.name: null
      pod: null

  {{- if $.Values.monitoring.enabled }}
serviceMonitors:
  - name: alloy-alloy-logs
    additionalLabels:
      app.kubernetes.io/instance: alloy
      app.kubernetes.io/name: alloy-logs
    selectorLabels:
      app.kubernetes.io/instance: alloy-alloy-logs
      app.kubernetes.io/name: alloy-logs
    {{- if and $istioEnabled (eq (dig "istio" "mtls" "mode" "STRICT" $.Values.alloy.values) "STRICT") }}
    scheme: https
    tlsConfig:
      caFile: /etc/prom-certs/root-cert.pem
      certFile: /etc/prom-certs/cert-chain.pem
      keyFile: /etc/prom-certs/key.pem
      insecureSkipVerify: true  # Prometheus does not support Istio security naming, thus skip verifying target pod certificate
    {{- end }}
  {{- end }}
  {{- end }}
{{- end }}