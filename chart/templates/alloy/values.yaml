{{- /* Create secret */ -}}
{{- if .Values.alloy.enabled }}
{{- /* Create a cleaned copy of alloy config and merge deprecated paths into current paths */ -}}
{{- $alloyPackage := deepCopy .Values.alloy -}}
{{- if .Values.alloy.values -}}
{{- $cleanedValues := include "mergeLegacyIstioHardenedKeys" (dict "values" .Values.alloy.values) | fromYaml -}}
{{- $alloyPackage = set $alloyPackage "values" $cleanedValues -}}
{{- end -}}
{{- include "values-secret" (dict 
  "root" $ 
  "package" $alloyPackage 
  "name" "alloy" 
  "defaults" ((mergeOverwrite (include "bigbang.defaults.alloy" . | fromYaml) (include "bigbang.alloy.bb-common-migrations" . | fromYaml)) | toYaml)
)}}
{{- end }}

{{- define "bigbang.defaults.alloy" -}}
{{- $alloyLogsEnabled := (dig "alloyLogs" "enabled" false .Values.alloy) }}
{{- $tempoEnabled := .Values.tempo.enabled }}
{{- $istioEnabled := eq (include "istioEnabled" .) "true" }}
{{- $istioHardenedEnabled := or (dig "istio" "hardened" "enabled" false .Values.alloy.values) (dig "hardened" "enabled" false .Values.istiod.values) }}

{{- $lokiServiceMap := dict
    "monolith" "logging-loki"
    "scalable" "logging-loki-write"
    "distributed" "logging-loki-distributor"
}}
{{- $lokiServiceName := index $lokiServiceMap .Values.loki.strategy }}
{{- $lokiWriteDestUrl := printf "http://%s.logging.svc.cluster.local:3100/loki/api/v1/push" $lokiServiceName }}

{{- $istioInjection := (and $istioEnabled (eq (dig "istio" "injection" "enabled" .Values.alloy) "enabled")) }}

monitoring:
  enabled: {{ .Values.monitoring.enabled }}

networkPolicies:
  enabled: {{ .Values.networkPolicies.enabled }}
  # note: ztunnel does not exist yet, defaulting to false until ambient package is added
  hbonePortInjection:
    enabled: {{ dig "enabled" false (default dict .Values.ztunnel) }}
  ingress:
    definitions: {{ .Values.networkPolicies.ingress.definitions | toYaml | nindent 6 }}
    to:
      # Allow alloy-metrics and Prometheus to scrape alloy-receiver
      alloy-receiver:12345:
        from:
          k8s:
            # Use full sa@namespace/pod format for same-namespace AuthorizationPolicy
            alloy-alloy-metrics@alloy/alloy-metrics: {{ dig "alloyMetrics" "enabled" false .Values.alloy }}
            monitoring-monitoring-kube-prometheus@monitoring/prometheus: {{ .Values.monitoring.enabled }}

      # Allow alloy-metrics and Prometheus to scrape alloy-logs
      alloy-logs:12345:
        from:
          k8s:
            # Use full sa@namespace/pod format for same-namespace AuthorizationPolicy
            alloy-alloy-metrics@alloy/alloy-metrics: {{ dig "alloyMetrics" "enabled" false .Values.alloy }}
            monitoring-monitoring-kube-prometheus@monitoring/prometheus: {{ .Values.monitoring.enabled }}

      # Allow Prometheus to scrape alloy-metrics
      alloy-metrics:12345:
        from:
          k8s:
            monitoring-monitoring-kube-prometheus@monitoring/prometheus: {{ .Values.monitoring.enabled }}
      {{- if $tempoEnabled }}
      # Allow any namespace to send traces to alloy-receiver via OTLP gRPC
      alloy-receiver:4317:
        from:
          k8s:
            "*/*": true
      # Allow any namespace to send traces to alloy-receiver via Zipkin
      alloy-receiver:9411:
        from:
          k8s:
            "*/*": true
      # Allow Prometheus to scrape metrics from alloy-receiver
      alloy-receiver:12345:
        from:
          k8s:
            monitoring-monitoring-kube-prometheus@monitoring/prometheus: {{ .Values.monitoring.enabled }}
      {{- end }}
  egress:
    definitions: {{ .Values.networkPolicies.egress.definitions | toYaml | nindent 6 }}
    from:
      alloy-logs:
        to:
          k8s:
            # Loki egress: namespace with app.kubernetes.io/name=logging, pod with app.kubernetes.io/name=logging-loki, port 3100
            logging/logging-loki:3100: {{ .Values.loki.enabled }}
      alloy:
        to:
          tempo/tempo:4317: {{ .Values.tempo.enabled }}
      {{- if $tempoEnabled }}
      # Allow alloy-receiver to forward traces to Tempo backend
      alloy-receiver:
        to:
          k8s:
            tempo/tempo:4317: true
      {{- end }}
istio:
  enabled: {{ $istioEnabled }}

  sidecar:
    enabled: {{ $istioHardenedEnabled }}

  authorizationPolicies:
    enabled: {{ $istioHardenedEnabled }}
    generateFromNetpol: {{ $istioHardenedEnabled }}

upstream:
  {{- if .Values.kiali.enabled }}
  alloy:
    extraLabels:
      service.istio.io/canonical-name: alloy-alloy-logs
  {{- end }}
  destinations:
    {{- if and $alloyLogsEnabled .Values.loki.enabled }}
    - name: loki
      type: loki
      url: {{ $lokiWriteDestUrl }}
    {{- end }}
    {{- if $tempoEnabled }}
    - name: tempo
      type: otlp
      url: http://tempo-tempo.tempo.svc.cluster.local:4317
      tls:
        insecure: true
    {{- end }}
  {{- if .Values.alloy.additionalDestinations }}
  {{- toYaml .Values.alloy.additionalDestinations | nindent 4 }}
  {{- end }}
  {{- if $alloyLogsEnabled }}
  alloy-logs:
    enabled: true
  podLogs:
    enabled: true
    destinations:
      {{- if .Values.loki.enabled }}
      - loki
      {{- end }}
      {{- if .Values.alloy.additionalDestinations }}
      {{- range $dest := .Values.alloy.additionalDestinations }}
      {{- if eq (lower $dest.type) "loki" }}
      - {{ $dest.name }}
      {{- end }}
      {{- end }}
      {{- end }}
    collector: alloy-logs
    labelsToKeep:
      - app.kubernetes.io/name
      - container
      - instance
      - job
      - level
      - namespace
      - service.name
      - service.namespace
      - deployment.environment
      - deployment.environment.name
      - k8s.namespace.name
      - k8s.deployment.name
      - k8s.statefulset.name
      - k8s.daemonset.name
      - k8s.cronjob.name
      - k8s.job.name
      - k8s.node.name
      - k8s.pod.name
      - pod
    structuredMetadata:
      k8s.pod.name: null
      pod: null
  {{- end }}
  {{- if $tempoEnabled }}
  # Enable alloy-receiver to collect traces and forward to Tempo
  alloy-receiver:
    enabled: true
    alloy:
      extraPorts:
      - name: otlp-grpc
        port: 4317
        targetPort: 4317
        protocol: TCP
        appProtocol: grpc
      - name: zipkin
        port: 9411
        targetPort: 9411
        protocol: TCP
  applicationObservability:
    enabled: true
    receivers:
      otlp:
        grpc:
          enabled: true
      zipkin:
        enabled: true
    destinations:
      - tempo
  {{- end }}
  {{- if $.Values.monitoring.enabled }}
serviceMonitors:
  - name: alloy-alloy-logs
    additionalLabels:
      app.kubernetes.io/instance: alloy
      app.kubernetes.io/name: alloy-logs
    selectorLabels:
      app.kubernetes.io/instance: alloy-alloy-logs
      app.kubernetes.io/name: alloy-logs
    {{- if and $istioEnabled (eq (dig "istio" "mtls" "mode" "STRICT" $.Values.alloy.values) "STRICT") }}
    scheme: https
    tlsConfig:
      caFile: /etc/prom-certs/root-cert.pem
      certFile: /etc/prom-certs/cert-chain.pem
      keyFile: /etc/prom-certs/key.pem
      insecureSkipVerify: true  # Prometheus does not support Istio security naming, thus skip verifying target pod certificate
    {{- end }}
  {{- end }}
{{- end }}
