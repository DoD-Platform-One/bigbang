###########################################################################
# Base template for container builds and sets the default container tag.  #
# See docker.yml or kaniko.yml for specific builder implementations.      #
########################################################################### 
.container build:
  stage: build
  variables:
    # Ultimately the image will be build with the following reference
    # IMAGE: REGISTRY[:PORT]/USER/REPO[:TAG]
    # Duplicate these variables out so that they cna be overridden at the job level
    IMAGE: $CI_REGISTRY_IMAGE

# ------------------------------------------------------------------------------------
# Kaniko
# Builds an OCI Container image using Kaniko
# REQUIRES:  A working Dockerfile referenced in DOCKERFILE_NAME which exists in the DOCKERFILE_DIR
# ------------------------------------------------------------------------------------
.kaniko:
  extends: .container build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "Building ${IMAGE}:${CI_COMMIT_SHORT_SHA} using ${DOCKERFILE_DIR}/${DOCKERFILE_NAME}"
    - echo "$DOCKER_AUTH" > /kaniko/.docker/config.json

    - /kaniko/executor --context ${DOCKERFILE_DIR} --dockerfile ${DOCKERFILE_NAME} --destination ${IMAGE}:${CI_COMMIT_SHORT_SHA}