include:
  # Infrastructure
  - local: '/infrastructure/templates.yaml'

  # Clusters
  - local: '/clusters/templates.yaml'

# Single place to update image used for pipelines
.util-image:
  image: registry1.dso.mil/bigbang-ci/bb-ci:2.5.3

# Runner tags
.bigbang-runner-tags:
  tags:
    - bb-prod-ci
    - bigbang-runner
    - privileged

.graduated-runner-tags:
  tags:
    - bb-prod-ci
    - graduated-runner
    - privileged

.incubating-runner-tags:
  tags:
    - bb-prod-ci
    - incubating-runner
    - privileged

.sandbox-runner-tags:
  tags:
    - bb-prod-ci
    - sandbox-runner
    - privileged

.generic-runner-tags:
  tags:
    - bb-prod-ci
    - generic

.release-runner-tags:
  tags:
    - bb-prod-ci
    - release-runner
    - release

# Function to pull and source templates.sh
.templates:
  before_script:
    - git clone -b ${PIPELINE_REPO_BRANCH} ${PIPELINE_REPO} ${PIPELINE_REPO_DESTINATION}
    - source ${PIPELINE_REPO_DESTINATION}/library/templates.sh
    - package_auth_setup

.kubectl-output:
  extends: 
  - .util-image
  after_script:
    - source ${PIPELINE_REPO_DESTINATION}/library/templates.sh
    - get_all
    - get_events
    - bigbang_pipeline
    - get_debug

.oci-creation:
  extends:
    - .util-image
    - .generic-runner-tags
    - .templates
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - oci_release
  retry:
    max: 2
    when:
      - unknown_failure
      - stuck_or_timeout_failure
      - runner_system_failure