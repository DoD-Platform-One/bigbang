# Include library templates
include:
  - local: '/library/templates.yaml'

stages:
  - üè∑Ô∏è tag
  - ‚ò∏Ô∏è helm

variables:
  PIPELINE_REPO: https://repo1.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates.git
  PIPELINE_REPO_DESTINATION: "../pipeline-repo"
  PIPELINE_REPO_BRANCH: master

# ----------------------------------------------------------------------------------------------
# chart-tag
# ----------------------------------------------------------------------------------------------
auto tag:
  stage: üè∑Ô∏è tag
  extends:
    - .generic-runner-tags
    - .util-image
    - .templates
  rules:
    # run tag stage on commits to default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - get_chart_version
    - create_tag
  allow_failure:
    exit_codes:
      - 201
  retry:
    max: 2
    when:
      - unknown_failure
      - stuck_or_timeout_failure
      - runner_system_failure

# ----------------------------------------------------------------------------------------------
# oci-helm-publish
# ----------------------------------------------------------------------------------------------
helm library release:
  stage: ‚ò∏Ô∏è helm
  extends:
    - .graduated-runner-tags
    - .util-image
  variables:
    DOCKER_HOST: tcp://localhost:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_DRIVER: overlay2
  only:
    variables: 
      - $CI_COMMIT_TAG
  script:
    # Get Chart version and name
    - export CHART_VERSION=$(yq e ".version" "chart/Chart.yaml")
    - export CHART_NAME=$(yq e ".name" "chart/Chart.yaml")
    # Enable experimental helm features
    - export HELM_EXPERIMENTAL_OCI=1
    # Save off the chart
    - helm package chart
    # Login to the repo registry
    - echo ${CI_REGISTRY_PASSWORD} | helm registry login ${CI_REGISTRY_IMAGE} -u ${CI_REGISTRY_USER} --password-stdin
    # Push to the repo registry
    - helm push ${CHART_NAME}-${CHART_VERSION}.tgz oci://${CI_REGISTRY_IMAGE}
  retry:
    max: 2
    when:
      - unknown_failure
      - stuck_or_timeout_failure
      - runner_system_failure
