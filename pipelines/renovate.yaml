# Include templates and cluster creation jobs
include:
  - local: '/library/templates.yaml'

image: registry1.dso.mil/ironbank/container-hardening-tools/renovate/renovate:32.38.0

variables:
  LOG_LEVEL: "debug"
  RENOVATE_LOG_FILE_LEVEL: "debug"
  RENOVATE_LOG_FILE: "renovate.log"
  PIPELINE_REPO: https://repo1.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates.git
  PIPELINE_REPO_DESTINATION: "../pipeline-repo"
  PIPELINE_REPO_BRANCH: master

default:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-renovate
    paths:
      - $CI_PROJECT_DIR/renovate

renovate:on-schedule:
  extends: .templates
  only:
    - schedules
  tags:
    - bigbang
    - dogfood
    - generic
    - bbci
  script:
    - export PATH=${CI_PROJECT_DIR}/scripts:$PATH
    - renovate_download_external_deps
    - renovate $RENOVATE_EXTRA_FLAGS
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - "$RENOVATE_LOG_FILE"

# test self updates with dry-run
renovate:
  extends: .templates
  except:
    - schedules
  tags:
    - bigbang
    - dogfood
    - generic
    - bbci
  script:
    - export PATH=${CI_PROJECT_DIR}/scripts:$PATH
    - renovate_download_external_deps
    - renovate --dry-run $RENOVATE_EXTRA_FLAGS
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - "$RENOVATE_LOG_FILE"
