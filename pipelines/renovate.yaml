image: registry1.dso.mil/ironbank/container-hardening-tools/renovate/renovate:32.38.0

variables:
  RENOVATE_EXTRA_FLAGS: "--autodiscover=true"
  RENOVATE_BASE_DIR: $CI_PROJECT_DIR/renovate
  RENOVATE_ENDPOINT: $CI_API_V4_URL
  RENOVATE_PLATFORM: gitlab
  RENOVATE_GIT_AUTHOR: Renovate Bot <bot@renovateapp.com>
  RENOVATE_ONBOARDING_CONFIG: '{"$$schema": "https://docs.renovatebot.com/renovate-schema.json", "extends": ["config:base"] }'
  RENOVATE_OPTIMIZE_FOR_DISABLED: 'true'
  RENOVATE_REPOSITORY_CACHE: 'true'
  RENOVATE_REQUIRE_CONFIG: 'true'
  RENOVATE_ONBOARDING: 'false'
  RENOVATE_IGNORE_PR_AUTHOR: 'true'
  RENOVATE_EXTENDS: 'github>whitesource/merge-confidence:beta'
  RENOVATE_LOG_FILE: renovate.log
  RENOVATE_LOG_FILE_LEVEL: debug
  LOG_LEVEL: debug
  HARBOR_USER: $REGISTRY1_USER
  HARBOR_TOKEN: $REGISTRY1_PASSWORD

default:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-renovate
    paths:
      - $CI_PROJECT_DIR/renovate

renovate:on-schedule:
  only:
    - schedules
  tags:
    - bigbang
    - dogfood
    - generic
    - bbci
  before_script:
    - curl -sO https://repo1.dso.mil/platform-one/big-bang/apps/library-charts/gluon/-/raw/master/docs/README.md.gotmpl -o ${CI_PROJECT_DIR}/README.md.gotmpl
    - curl -sO https://repo1.dso.mil/platform-one/big-bang/apps/library-charts/gluon/-/raw/master/docs/.helmdocsignore -o ${CI_PROJECT_DIR}/.helmdocsignore
    - curl -sL https://github.com/norwoodj/helm-docs/releases/download/v1.7.0/helm-docs_1.7.0_Linux_x86_64.tar.gz -o ${CI_PROJECT_DIR}/helm-docs.tar.gz
    - tar xvf ${CI_PROJECT_DIR}/helm-docs.tar.gz -C ${CI_PROJECT_DIR}
  script:
    - renovate $RENOVATE_EXTRA_FLAGS
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - "$RENOVATE_LOG_FILE"

# test self updates with dry-run
renovate:
  except:
    - schedules
  tags:
    - bigbang
    - dogfood
    - generic
    - bbci
  before_script:
    - curl -sO https://repo1.dso.mil/platform-one/big-bang/apps/library-charts/gluon/-/raw/master/docs/README.md.gotmpl -o ${CI_PROJECT_DIR}/README.md.gotmpl
    - curl -sO https://repo1.dso.mil/platform-one/big-bang/apps/library-charts/gluon/-/raw/master/docs/.helmdocsignore -o ${CI_PROJECT_DIR}/.helmdocsignore
    - curl -sL https://github.com/norwoodj/helm-docs/releases/download/v1.7.0/helm-docs_1.7.0_Linux_x86_64.tar.gz -o ${CI_PROJECT_DIR}/helm-docs.tar.gz
    - tar xvf ${CI_PROJECT_DIR}/helm-docs.tar.gz -C ${CI_PROJECT_DIR}    
  script:
    - renovate --dry-run $RENOVATE_EXTRA_FLAGS
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - "$RENOVATE_LOG_FILE"
