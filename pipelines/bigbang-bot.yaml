image: registry1.dso.mil/ironbank/opensource/python/python38:3.8

variables:
# So long as the token permissions are the same, we are going to use the renovate token for the bb-bot. 
# If the bb-bot needs different permissions than renovate, we'll need to generate a token specifically for that function.
# - @gabe.scarberry
  gitlab_group_id: $BB_BOT_GROUP
  jira_username: $JIRA_USERNAME
  jira_url: $JIRA_URL
  gitlab_url: $GITLAB_URL

# workflow:
#   rules:
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Include templates
include:
  - local: '/library/templates.yaml'

stages:
  - test
  - dry_run
  - scheduled

before_script:
  - python --version  # For debugging
  - python -m venv ./venv
  - source venv/bin/activate
  - python -m pip install -r requirements.txt

bb-bot:on-schedule-gitlab:
  stage: scheduled
  variables: 
    gitlab_access_token: $RENOVATE_TOKEN
  only:
    refs: 
      - schedules
    variables: 
      - $GITLAB == "true"
  extends:
    - .generic-runner-tags
  artifacts:
    when: always
    expire_in: 2 weeks
    paths:
      - "*.log"
  script:
    - python bigbang_bot.py --no-dry-run --gitlab-url https://repo1.dso.mil run-all-modules

bb-bot:on-schedule-jira:
  stage: scheduled
  variables:
    gitlab_access_token: $RO_RENOVATE_TOKEN
    jira_access_token: $JIRA_TOKEN
  only:
    refs: 
      - schedules
    variables: 
      - $JIRA == "true"
  extends:
    - .generic-runner-tags
  artifacts:
    when: always
    expire_in: 2 weeks
    paths:
      - "*.log"
  script:
    - python bigbang_bot.py --no-dry-run --gitlab-url https://repo1.dso.mil sync-jira-issues

bb-bot-gitlab:
  stage: dry_run
  variables: 
    gitlab_access_token: $RO_RENOVATE_TOKEN
  except:
    - schedules
  extends:
    - .generic-runner-tags
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - "*.log"
  script:
    - python bigbang_bot.py --gitlab-url https://repo1.dso.mil run-all-modules

bb-bot-jira:
  stage: dry_run
  variables: 
    gitlab_access_token: $RO_RENOVATE_TOKEN
    jira_access_token: $RO_JIRA_TOKEN
  except:
    - schedules
  extends:
    - .generic-runner-tags
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - "*.log"
  script:
    - python bigbang_bot.py --gitlab-url https://repo1.dso.mil sync-jira-issues

test:
  stage: test
  extends:
    - .generic-runner-tags
  script:
    - python -m pip install -r requirements-test.txt
    - pytest . 
