include:
  - local: /jobs/build/base.yml
  - local: /jobs/scan/base.yml
  - local: /jobs/promote/base.yml

stages:
  - build
  - scan
  - promote

# ----------------------------------------------------------------------------------------------
# k3d-builder
# ----------------------------------------------------------------------------------------------
.k3d-builder:
  only:
    changes:
      - .gitlab-ci.yml
      - jobs/k3d-builder/Dockerfile
  variables:
    DOCKERFILE_DIR: jobs/k3d-builder
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/k3d-builder

kaniko k3d-builder:
  extends: 
    - .kaniko
    - .k3d-builder

trivy scan k3d-builder:
  extends:
    - .trivy scan
    - .k3d-builder

promote k3d-builder:
  extends:
    - .promote
    - .k3d-builder
    
# ----------------------------------------------------------------------------------------------
# go-dnsmasq
# ----------------------------------------------------------------------------------------------
.go-dnsmasq:
  only:
    changes:
      - .gitlab-ci.yml
      - jobs/go-dnsmasq/Dockerfile
  variables:
    DOCKERFILE_DIR: jobs/go-dnsmasq
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/go-dnsmasq

kaniko go-dnsmasq:
  extends: 
    - .kaniko
    - .go-dnsmasq

trivy scan go-dnsmasq:
  extends:
    - .trivy scan
    - .go-dnsmasq

promote go-dnsmasq:
  extends:
    - .promote
    - .go-dnsmasq
    
# ----------------------------------------------------------------------------------------------
# k3d-builder-local
# ----------------------------------------------------------------------------------------------
.k3d-builder-local:
  only:
    changes:
      - .gitlab-ci.yml
      - local-dev/k3d-builder-local/Dockerfile
  variables:
    DOCKERFILE_DIR: local-dev/k3d-builder-local
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/k3d-builder-local

kaniko k3d-builder-local:
  extends: 
    - .kaniko
    - .k3d-builder-local

trivy scan k3d-builder-local:
  extends:
    - .trivy scan
    - .k3d-builder-local

promote k3d-builder-local:
  extends:
    - .promote
    - .k3d-builder-local
