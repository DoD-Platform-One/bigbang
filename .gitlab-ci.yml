include:
  - local: /jobs/build/base.yml
  - local: /jobs/scan/base.yml
  - local: /jobs/promote/base.yml

stages:
  - helm
  - build
  - scan
  - promote

# ----------------------------------------------------------------------------------------------
# k3d-builder
# ----------------------------------------------------------------------------------------------
.k3d-builder:
  only:
    changes:
      - .gitlab-ci.yml
      - jobs/k3d-builder/Dockerfile
  variables:
    DOCKERFILE_DIR: jobs/k3d-builder
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/k3d-builder

kaniko k3d-builder:
  extends: 
    - .kaniko
    - .k3d-builder

trivy scan k3d-builder:
  extends:
    - .trivy scan
    - .k3d-builder

promote k3d-builder:
  extends:
    - .promote
    - .k3d-builder
    
# ----------------------------------------------------------------------------------------------
# go-dnsmasq
# ----------------------------------------------------------------------------------------------
.go-dnsmasq:
  only:
    changes:
      - .gitlab-ci.yml
      - jobs/go-dnsmasq/Dockerfile
  variables:
    DOCKERFILE_DIR: jobs/go-dnsmasq
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/go-dnsmasq

kaniko go-dnsmasq:
  extends: 
    - .kaniko
    - .go-dnsmasq

trivy scan go-dnsmasq:
  extends:
    - .trivy scan
    - .go-dnsmasq

promote go-dnsmasq:
  extends:
    - .promote
    - .go-dnsmasq
    
# ----------------------------------------------------------------------------------------------
# k3d-builder-local
# ----------------------------------------------------------------------------------------------
.k3d-builder-local:
  only:
    changes:
      - .gitlab-ci.yml
      - local-dev/k3d-builder-local/Dockerfile
  variables:
    DOCKERFILE_DIR: local-dev/k3d-builder-local
    DOCKERFILE_NAME: Dockerfile
    IMAGE: $CI_REGISTRY_IMAGE/k3d-builder-local

kaniko k3d-builder-local:
  extends: 
    - .kaniko
    - .k3d-builder-local

trivy scan k3d-builder-local:
  extends:
    - .trivy scan
    - .k3d-builder-local

promote k3d-builder-local:
  extends:
    - .promote
    - .k3d-builder-local

# ----------------------------------------------------------------------------------------------
# oci-helm-library
# ----------------------------------------------------------------------------------------------
helm library release:
  stage: helm
  tags:
    - bigbang
    - privileged
    - dogfood
    - packages
  variables:
    DOCKER_HOST: tcp://localhost:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_DRIVER: overlay2
  only:
    variables: 
      - $CI_COMMIT_TAG
  image: registry.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates/k3d-builder:0.0.5
  script:
    # Get Chart version
    - export CHART_VERSION=$(yq e ".version" "bb-test-lib/Chart.yaml")
    # Enable experimental helm features
    - export HELM_EXPERIMENTAL_OCI=1
    # Save off the chart
    - helm chart save bb-test-lib ${CI_REGISTRY_IMAGE}/bb-test-lib:${CHART_VERSION}
    # Login to the repo registry
    - echo ${CI_REGISTRY_PASSWORD} | helm registry login ${CI_REGISTRY_IMAGE} -u ${CI_REGISTRY_USER} --password-stdin
    # Push to the repo registry
    - helm chart push ${CI_REGISTRY_IMAGE}/bb-test-lib:${CHART_VERSION}
