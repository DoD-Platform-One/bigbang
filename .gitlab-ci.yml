stages:
  - helm

# ----------------------------------------------------------------------------------------------
# oci-helm-library
# ----------------------------------------------------------------------------------------------
helm library release:
  stage: helm
  tags:
    - bigbang
    - privileged
    - dogfood
    - packages
  variables:
    DOCKER_HOST: tcp://localhost:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_DRIVER: overlay2
  only:
    variables: 
      - $CI_COMMIT_TAG
  image: registry.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates/k3d-builder:0.0.5
  script:
    # Get Chart version
    - export CHART_VERSION=$(yq e ".version" "bb-test-lib/Chart.yaml")
    # Enable experimental helm features
    - export HELM_EXPERIMENTAL_OCI=1
    # Save off the chart
    - helm chart save bb-test-lib ${CI_REGISTRY_IMAGE}/bb-test-lib:${CHART_VERSION}
    # Login to the repo registry
    - echo ${CI_REGISTRY_PASSWORD} | helm registry login ${CI_REGISTRY_IMAGE} -u ${CI_REGISTRY_USER} --password-stdin
    # Push to the repo registry
    - helm chart push ${CI_REGISTRY_IMAGE}/bb-test-lib:${CHART_VERSION}
